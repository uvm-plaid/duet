
-- evaluate a clipping parameter: return how many
-- rows would be clipped by using that parameter
let evalClippingParam =
            sÎ» .
               b: ğ”»
               â‡’
               sÎ» m  : â„•
                  .
                  xs : ğ•„ [Lâˆ, U|m, 1â‹…ğ”» ]
                  â‡’
  let scaled   = mmap xs { x â‡’ b â‹… x } in
  let clipped  = mmap (mclip[L2] scaled) { x â‡’ x } in
  let filtered = mfilter zip[clipped, xs] { row  â‡’ 
                   let âŸ¨clipped, origâŸ© = row#[â„•[0], â„•[0]] in
                   clipped â‰¡ orig } in
  â„âº[0.5] â‹… real (rows filtered)
in

-- determine the scale of a matrix (i.e. best clipping parameter)
let selectClippingParam =
           pÎ» m  : â„•,
              Îµ  : â„âº,
              k  : â„•
              .
              xs : ğ•„ [Lâˆ, U|m, 1â‹…ğ”» ] ,
              Îµ  : â„âº[Îµ],
              bs : ğ•„ [Lâˆ, U|1, kâ‹…ğ”» ]
              â‡’
  let target = 0.9 â‹… real (rows xs) in
  let fs = mmap bs { b â‡’ evalClippingParam b } in
  bIdx â† AboveThreshold [ Îµ, fs, target ] <xs> { xs };
  return bs#[idx â„•[0], bIdx]
in

-- determine the mean of a single column matrix
let colMean = pÎ» m   : â„•,
                 k   : â„•,
                 Îµ   : â„âº,
                 Î´   : â„âº
                 .
                 mat : ğ•„ [Lâˆ, U|m, 1â‹…ğ”» ],
                 Îµ   : â„âº[Îµ],
                 Î´   : â„âº[Î´],
                 bs  : ğ•„ [Lâˆ, U|1, kâ‹…ğ”» ]
                 â‡’
  b â† selectClippingParam@[m, Îµ, k. mat, Îµ, bs];
  mean â† gauss [â„âº[1.0] / (real (rows mat)), Îµ, Î´] <mat> {
    let scaled   = mmap mat { x â‡’ b â‹… x } in
    let clipped  = mconv (mclip[L1] scaled) in
    let sum      = mfold-row 0.0, clipped { a, r â‡’
                     a + r#[idx â„•[0], idx â„•[0]] } in
    sum / (real (rows mat))
  };
  return (disc mean)
in

-- determine the mean of each column in the given matrix
let colMeans = pÎ» m : â„•, n : â„•, k : â„•, Îµ : â„âº, Î´ : â„âº
                  .
                  mat : ğ•„ [Lâˆ, U|m, nâ‹…ğ”» ],
                  Îµ   : â„âº[Îµ],
                  Î´   : â„âº[Î´],
                  bs  : ğ•„ [Lâˆ, U|1, kâ‹…ğ”» ]
                  â‡’
  pmap-col mat { col â‡’ colMean@[m, k, Îµ, Î´. col, Îµ, Î´, bs] }
in


let center =
  sÎ» m : â„•, n : â„•
     .
     mat    : ğ•„ [Lâˆ, U|m, nâ‹…ğ”» ],
     means  : ğ•„ [Lâˆ, U|1, nâ‹…ğ”» ]
     â‡’
  -- center the values using the column mean
  mmap-col mat, means { col, mean â‡’
    mmap col { x â‡’
      x - mean#[idx â„•[0], idx â„•[0]]
    }
  }
in

-- determine the scale of each column in the given matrix
let colScaleParams =
  pÎ» m : â„•, n : â„•, Îµ : â„âº, Î´ : â„âº, k : â„•
     .
     mat   : ğ•„ [Lâˆ, U|m, nâ‹…ğ”» ],
     Îµ     : â„âº[Îµ],
     Î´     : â„âº[Î´],
     bs    : ğ•„ [Lâˆ, U|1, kâ‹…ğ”» ],
     means : ğ•„ [Lâˆ, U|1, nâ‹…ğ”» ]
     â‡’
  pmap-col (center@[m,n] mat means) { col â‡’ selectClippingParam@[m, Îµ, k. col, Îµ, bs] }
 -- return center@[m,n] mat means
in

-- given a mean and scale for each column, prepare
-- the given matrix for clipping
let normalize =
  sÎ» m : â„•, n : â„•
     .
     means  : ğ•„ [Lâˆ, U|1, nâ‹…ğ”» ],
     scales : ğ•„ [Lâˆ, U|1, nâ‹…ğ”» ],
     mat    : ğ•„ [Lâˆ, U|m, nâ‹…ğ”» ]
     â‡’
  -- center the values using the column mean
  let centered = center@[m,n] mat means in

  -- scale the values using the clipping parameters
  mmap-col centered, scales { col, scale â‡’
    mmap col { x â‡’
      x / (scale#[idx â„•[0], idx â„•[0]])
    }
  }
in

let noisySGD =
  pÎ» m : â„•, n  : â„•, Îµ  : â„âº, k  : â„•, Î´  : â„âº, Î´â€² : â„âº
     .
     xs : ğ•„ [Lâˆ, U|m, nâ‹…ğ”» ] ,
     ys : ğ•„ [Lâˆ, U|m, 1â‹…ğ”» ] ,
     Îµ  : â„âº[Îµ],
     k  : â„•[k],
     Î´  : â„âº[Î´],
     Î´â€² : â„âº[Î´â€²],
     Î·  : â„
     â‡’
  let mâ‚€ = mcreate[ Lâˆ | â„•[1] , cols xs ] { i , j â‡’ 0.0 } in
  let c = box (mclip[L2] xs) in
  aloop[ Î´â€² ] k on mâ‚€ <xs,ys> { a, Î¸ â‡’
    let s = â„âº[1.0] / real (rows xs) in
    g â† mgauss[ s , Îµ , Î´ ] <xs,ys> { âˆ‡[ LR | Î¸ ; unbox c , ys ] } ;
    return mmap Î¸ , mmap g { x â‡’ Î· â‹… x } { x , y â‡’ x - y }
  }
in

let main =
  pÎ» m : â„•, n : â„•, k : â„•, Îµ : â„âº, Î´ : â„âº, Î´â€² : â„âº
     .
     xs : ğ•„ [Lâˆ, U|m, nâ‹…ğ”» ] ,
     ys : ğ•„ [Lâˆ, U|m, 1â‹…ğ”» ] ,
     Îµ   : â„âº[Îµ],
     k  : â„•[k],
     Î´  : â„âº[Î´],
     Î´â€² : â„âº[Î´â€²],
     Î·  : â„,
     bs  : ğ•„ [Lâˆ, U|1, kâ‹…ğ”» ]
     â‡’
  means  â† colMeans@[m,n,k,Îµ,Î´. xs, Îµ, Î´, bs];
  scales â† colScaleParams@[m,n,Îµ,Î´,k. xs, Îµ, Î´, bs, means];
  let normalizeF = normalize@[m,n] means scales in
  noisySGD@[m,n,Îµ,k,Î´,Î´â€² . normalizeF xs, ys, Îµ, k, Î´, Î´â€², Î·]
--  return (unbox xsâ€²)
  
in main

